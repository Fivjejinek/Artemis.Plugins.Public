name: Build Plugins

on:
  workflow_dispatch:

jobs:
  build-all:
    runs-on: windows-latest
    steps:
      - name: Setup .NET SDKs
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            9.0.x

      # Checkout Artemis repo into ./Artemis
      - name: Clone Artemis
        uses: actions/checkout@v4
        with:
          repository: Artemis-RGB/Artemis
          ref: development
          path: Artemis

      # Checkout Plugins repo into ./Plugins
      - name: Clone Plugins
        uses: actions/checkout@v4
        with:
          repository: Fivjejinek/Artemis.Plugins.Public
          path: Plugins

      # Build Artemis core projects so references are available
      - name: Build Artemis Core
        run: dotnet build -c Release Artemis/src/Artemis.Core/Artemis.Core.csproj
      - name: Build Artemis UI Shared
        run: dotnet build -c Release Artemis/src/Artemis.UI.Shared/Artemis.UI.Shared.csproj
      - name: Build Artemis UI
        run: dotnet build -c Release Artemis/src/Artemis.UI/Artemis.UI.csproj
      - name: Build Artemis Storage
        run: dotnet build -c Release Artemis/src/Artemis.Storage/Artemis.Storage.csproj
      - name: Build Artemis WebClient Updating
        run: dotnet build -c Release Artemis/src/Artemis.WebClient.Updating/Artemis.WebClient.Updating.csproj

      # --- Build & Upload Plugins sequentially ---
      - name: Publish ExtendedWebAPI
        run: dotnet publish -c Release Plugins/src/Collections/Artemis.Plugins.ExtendedWebAPI/Artemis.Plugins.ExtendedWebAPI.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.ExtendedWebAPI
          path: |
            Plugins/src/Collections/Artemis.Plugins.ExtendedWebAPI/bin/Release/net9.0-windows/publish/Artemis.Plugins.ExtendedWebAPI.dll
            Plugins/src/Collections/Artemis.Plugins.ExtendedWebAPI/bin/Release/net9.0-windows/publish/plugin.json
            Plugins/src/Collections/Artemis.Plugins.ExtendedWebAPI/bin/Release/net9.0-windows/publish/*.png

      - name: Publish DisplaySettings
        run: dotnet publish -c Release Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.DisplaySettings/Artemis.Plugins.DataModelExpansions.DisplaySettings.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.DataModelExpansions.DisplaySettings
          path: |
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.DisplaySettings/bin/Release/net9.0-windows/publish/Artemis.Plugins.DataModelExpansions.DisplaySettings.dll
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.DisplaySettings/bin/Release/net9.0-windows/publish/plugin.json
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.DisplaySettings/bin/Release/net9.0-windows/publish/*.png

      - name: Publish Teams
        run: dotnet publish -c Release Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Teams/Artemis.Plugins.DataModelExpansions.Teams.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.DataModelExpansions.Teams
          path: |
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Teams/bin/Release/net9.0-windows/publish/Artemis.Plugins.DataModelExpansions.Teams.dll
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Teams/bin/Release/net9.0-windows/publish/plugin.json
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Teams/bin/Release/net9.0-windows/publish/*.png

      - name: Publish OpenWeather
        run: dotnet publish -c Release Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.OpenWeather/Artemis.Plugins.DataModelExpansions.OpenWeather.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.DataModelExpansions.OpenWeather
          path: |
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.OpenWeather/bin/Release/net9.0-windows/publish/Artemis.Plugins.DataModelExpansions.OpenWeather.dll
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.OpenWeather/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish PowerPlan
        run: dotnet publish -c Release Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.PowerPlan/Artemis.Plugins.DataModelExpansions.PowerPlan.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.DataModelExpansions.PowerPlan
          path: |
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.PowerPlan/bin/Release/net9.0-windows/publish/Artemis.Plugins.DataModelExpansions.PowerPlan.dll
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.PowerPlan/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish Profiles
        run: dotnet publish -c Release Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Profiles/Artemis.Plugins.DataModelExpansions.Profiles.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.DataModelExpansions.Profiles
          path: |
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Profiles/bin/Release/net9.0-windows/publish/Artemis.Plugins.DataModelExpansions.Profiles.dll
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Profiles/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish YTMdesktop
        run: dotnet publish -c Release Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.YTMdesktop/Artemis.Plugins.DataModelExpansions.YTMdesktop.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.DataModelExpansions.YTMdesktop
          path: |
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.YTMdesktop/bin/Release/net9.0-windows/publish/Artemis.Plugins.DataModelExpansions.YTMdesktop.dll
            Plugins/src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.YTMdesktop/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish PowerPlay
        run: dotnet publish -c Release Plugins/src/Device/PowerPlay/Artemis.Plugins.Devices.PowerPlay/Artemis.Plugins.Devices.PowerPlay.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.Devices.PowerPlay
          path: |
            Plugins/src/Device/PowerPlay/Artemis.Plugins.Devices.PowerPlay/bin/Release/net9.0-windows/publish/Artemis.Plugins.Devices.PowerPlay.dll
            Plugins/src/Device/PowerPlay/Artemis.Plugins.Devices.PowerPlay/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish YeeLight
        run: dotnet publish -c Release Plugins/src/Device/YeeLight/Artemis.Plugins.Devices.YeeLight/Artemis.Plugins.Devices.YeeLight.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.Devices.YeeLight
          path: |
            Plugins/src/Device/YeeLight/Artemis.Plugins.Devices.YeeLight/bin/Release/net9.0-windows/publish/Artemis.Plugins.Devices.YeeLight.dll
            Plugins/src/Device/YeeLight/Artemis.Plugins.Devices.YeeLight/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish ConnectingDots
        run: dotnet publish -c Release Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.ConnectingDots/Artemis.Plugins.LayerBrushes.ConnectingDots.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.LayerBrushes.ConnectingDots
          path: |
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.ConnectingDots/bin/Release/net9.0-windows/publish/Artemis.Plugins.LayerBrushes.ConnectingDots.dll
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.ConnectingDots/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish DrippingPaint
        run: dotnet publish -c Release Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.DrippingPaint/Artemis.Plugins.LayerBrushes.DrippingPaint.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.LayerBrushes.DrippingPaint
          path: |
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.DrippingPaint/bin/Release/net9.0-windows/publish/Artemis.Plugins.LayerBrushes.DrippingPaint.dll
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.DrippingPaint/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish Nexus
        run: dotnet publish -c Release Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Nexus/Artemis.Plugins.LayerBrushes.Nexus.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.LayerBrushes.Nexus
          path: |
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Nexus/bin/Release/net9.0-windows/publish/Artemis.Plugins.LayerBrushes.Nexus.dll
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Nexus/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish Ripples
        run: dotnet publish -c Release Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Ripples/Artemis.Plugins.LayerBrushes.Ripples.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.LayerBrushes.Ripples
          path: |
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Ripples/bin/Release/net9.0-windows/publish/Artemis.Plugins.LayerBrushes.Ripples.dll
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Ripples/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish Shuffle
        run: dotnet publish -c Release Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Shuffle/Artemis.Plugins.LayerBrushes.Shuffle.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.LayerBrushes.Shuffle
          path: |
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Shuffle/bin/Release/net9.0-windows/publish/Artemis.Plugins.LayerBrushes.Shuffle.dll
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.Shuffle/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish SolidPercentage
        run: dotnet publish -c Release Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.SolidPercentage/Artemis.Plugins.LayerBrushes.SolidPercentage.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.LayerBrushes.SolidPercentage
          path: |
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.SolidPercentage/bin/Release/net9.0-windows/publish/Artemis.Plugins.LayerBrushes.SolidPercentage.dll
            Plugins/src/LayerBrushes/Artemis.Plugins.LayerBrushes.SolidPercentage/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish FlickeringLights
        run: dotnet publish -c Release Plugins/src/LayerEffects/Artemis.Plugins.LayerEffect.FlickeringLights/Artemis.Plugins.LayerEffect.FlickeringLights.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.LayerEffect.FlickeringLights
          path: |
            Plugins/src/LayerEffects/Artemis.Plugins.LayerEffect.FlickeringLights/bin/Release/net9.0-windows/publish/Artemis.Plugins.LayerEffect.FlickeringLights.dll
            Plugins/src/LayerEffects/Artemis.Plugins.LayerEffect.FlickeringLights/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish JsonModule
        run: dotnet publish -c Release Plugins/src/Modules/Artemis.Plugins.Modules.Json/Artemis.Plugins.Modules.Json.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.Modules.Json
          path: |
            Plugins/src/Modules/Artemis.Plugins.Modules.Json/bin/Release/net9.0-windows/publish/Artemis.Plugins.Modules.Json.dll
            Plugins/src/Modules/Artemis.Plugins.Modules.Json/bin/Release/net9.0-windows/publish/plugin.json

      - name: Publish NodesExtra
        run: dotnet publish -c Release Plugins/src/Nodes/Artemis.Plugins.Nodes.Extra/Artemis.Plugins.Nodes.Extra.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Artemis.Plugins.Nodes.Extra
          path: |
            Plugins/src/Nodes/Artemis.Plugins.Nodes.Extra/bin/Release/net9.0-windows/publish/Artemis.Plugins.Nodes.Extra.dll
            Plugins/src/Nodes/Artemis.Plugins.Nodes.Extra/bin/Release/net9.0-windows/publish/plugin.json
